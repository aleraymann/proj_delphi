unit uPrincipal;

interface

uses
   Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Menus, uDtmConexao, Enter,
  ufrmAtualizaDB, ShellApi, Vcl.ExtCtrls, Vcl.StdCtrls, Vcl.ComCtrls,
  VclTee.TeeGDIPlus, Data.DB, VCLTee.Series, VCLTee.TeEngine, VCLTee.TeeProcs,
  VCLTee.Chart, VCLTee.DBChart, cUsuarioLogado, ZDbcIntfs, RLReport,
  ZAbstractRODataset, ZAbstractDataset, ZDataset,cAtualizacaoBancoDeDados;

type
  TfrmPrincipal = class(TForm)
    mainPrincipal: TMainMenu;
    Cadastro1: TMenuItem;
    Movimentao1: TMenuItem;
    Relatrios1: TMenuItem;
    Cliente1: TMenuItem;
    N1: TMenuItem;
    Categoria1: TMenuItem;
    Produto1: TMenuItem;
    N2: TMenuItem;
    menuFechar: TMenuItem;
    Vendas1: TMenuItem;
    Cliente2: TMenuItem;
    N3: TMenuItem;
    Produto2: TMenuItem;
    N4: TMenuItem;
    VendaporData1: TMenuItem;
    Categoria: TMenuItem;
    FichadeClientes1: TMenuItem;
    ProdutoporCategoria1: TMenuItem;
    Usurio1: TMenuItem;
    N5: TMenuItem;
    AlterarSenha1: TMenuItem;
    stpPrincipal: TStatusBar;
    procedure menuFecharClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure Categoria1Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Cliente1Click(Sender: TObject);
    procedure Produto1Click(Sender: TObject);
    procedure Vendas1Click(Sender: TObject);
    procedure CategoriaClick(Sender: TObject);
    procedure Cliente2Click(Sender: TObject);
    procedure FichadeClientes1Click(Sender: TObject);
    procedure Produto2Click(Sender: TObject);
    procedure ProdutoporCategoria1Click(Sender: TObject);
    procedure VendaporData1Click(Sender: TObject);
    procedure Usurio1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure AlterarSenha1Click(Sender: TObject);
  private
    { Private declarations }
    TeclaEnter: TMREnter;
    procedure AtualizaBancoDados(aForm: TfrmAtualizaDB);
  public
    { Public declarations }
  end;

var
  frmPrincipal: TfrmPrincipal;
  oUsuarioLogado: TUsuarioLogado;

implementation

{$R *.dfm}

uses uCadCategoria, uCadCliente, uCadProduto, uProVendas,
  uRelCadProduto, uRelCadCliente, uCadUsuario,
  uLogin, uAlterarSenha, cCadUsuario, uTelaHeranca, uRelCategoria, uRelCadProdutoComGrupoCategoria,
  uRelCadClienteFicha, uRelVenda, uRelVendaPorData, uSelecioanarData, cProVenda;


procedure TfrmPrincipal.Categoria1Click(Sender: TObject);
begin
   frmCadCategoria:=TfrmCadCategoria.Create(Self);
   frmCadCategoria.ShowModal;
   frmCadCategoria.Release;
end;

procedure TfrmPrincipal.CategoriaClick(Sender: TObject);
begin
        frmRelCategoria:=TfrmRelCategoria.Create(Self);
        frmRelCategoria.Relatorio.PreviewModal;
        frmRelCategoria.Release;
end;

procedure TfrmPrincipal.Cliente1Click(Sender: TObject);
begin
   frmCadCliente:=TfrmCadCliente.Create(Self);
   frmCadCliente.ShowModal;
   frmCadCliente.Release;
end;



procedure TfrmPrincipal.Cliente2Click(Sender: TObject);
begin
        frmRelCadCliente:=TfrmRelCadCliente.Create(Self);
         frmRelCadCliente.Relatorio.PreviewModal;
         frmRelCadCliente.Release;
end;

procedure TfrmPrincipal.FichadeClientes1Click(Sender: TObject);
begin

        frmRelCadClienteFicha:=TfrmRelCadClienteFicha.Create(Self);
         frmRelCadClienteFicha.Relatorio.PreviewModal;
         frmRelCadClienteFicha.Release;
end;

procedure TfrmPrincipal.FormClose(Sender: TObject; var Action: TCloseAction);
begin
       FreeAndNil(TeclaEnter);
       FreeAndNil(dtmPrincipal);

       if Assigned(oUsuarioLogado) then
       FreeAndNil(oUsuarioLogado);

end;

procedure TfrmPrincipal.FormCreate(Sender: TObject);
begin
//cria conexao no formPrincipal
{
      dtmPrincipal :=   TdtmPrincipal.Create(Self);
      dtmPrincipal.ConexaoDB.SQLHourGlass:=True;
      dtmPrincipal.ConexaoDB.Protocol:= 'mssql';
      dtmPrincipal.ConexaoDB.LibraryLocation:='C:\Delphi\ntwdblib.dll';
      dtmPrincipal.ConexaoDB.HostName:='.\SQLDELPHI';
      dtmPrincipal.ConexaoDB.Port:=1433;
      dtmPrincipal.ConexaoDB.User:='sa';
      dtmPrincipal.ConexaoDB.Password:='132028';
      dtmPrincipal.ConexaoDB.Database:='vendas';

      dtmPrincipal.ConexaoDB.Connected :=true;
}
      frmAtualizaDB:=TfrmAtualizaDB.Create(self);
      frmAtualizaDB.Show;
      frmAtualizaDB.refresh;

      dtmPrincipal :=   TdtmPrincipal.Create(Self);
        with dtmPrincipal.ConexaoDB do
      begin
        SQLHourGlass:=True;
        Protocol:= 'mssql';
        LibraryLocation:='C:\Delphi\ntwdblib.dll';
        HostName:='.\SQLDELPHI';
        Port:=1433;
        User:='sa';
        Password:='132028';
        Database:='vendas';
        AutoCommit := True;
        TransactIsolationLevel:= tiReadCommitted;
        Connected :=true;
      end;
       AtualizaBancoDados(frmAtualizaDB);
      frmAtualizaDB.Free;
      TeclaEnter:=TMREnter.Create(Self);
      TeclaEnter.FocusEnabled:=true;
      TeclaEnter.FocusColor:=clInfoBk;
end;

procedure TfrmPrincipal.FormShow(Sender: TObject);
begin
      try
         oUsuarioLogado :=TUsuarioLogado.Create;
         frmLogin:=TfrmLogin.Create(Self);
          frmLogin.ShowModal;
      finally
        frmLogin.Release;
       stpPrincipal.Panels[0].Text:='Usuário: ' + oUsuarioLogado.nome;
      end;


end;

procedure TfrmPrincipal.menuFecharClick(Sender: TObject);
begin
  //Close;
  Application.Terminate;
end;

procedure TfrmPrincipal.Produto1Click(Sender: TObject);
begin
    frmCadastroProduto:=TfrmCadastroProduto.Create(Self);
   frmCadastroProduto.ShowModal;
   frmCadastroProduto.Release;
end;


procedure TfrmPrincipal.Produto2Click(Sender: TObject);
begin

    frmRelCadProduto:=TfrmRelCadProduto.Create(Self);
   frmRelCadProduto.Relatorio.PreviewModal;
   frmRelCadProduto.Release;
end;

procedure TfrmPrincipal.ProdutoporCategoria1Click(Sender: TObject);
begin
   frmRelCadProdutoComGrupoCategoria:=TfrmRelCadProdutoComGrupoCategoria.Create(Self);
   frmRelCadProdutoComGrupoCategoria.Relatorio.PreviewModal;
   frmRelCadProdutoComGrupoCategoria.Release;
end;

procedure TfrmPrincipal.Usurio1Click(Sender: TObject);
begin
    frmCadUsuario := TfrmCadUsuario.create(self);
    frmCadUsuario.showModal;
    frmCadUsuario.release;
end;

procedure TfrmPrincipal.VendaporData1Click(Sender: TObject);
begin
Try
   frmSelecionarData:=TfrmSelecionarData.Create(self);
   frmSelecionarData.ShowModal;

   frmRelVendaPorData:=TfrmRelVendaPorData.Create(self);
   frmRelVendaPorData.QryVenda.Close;
   frmRelVendaPorData.QryVenda.ParamByName('DataInicio').AsDate:=frmSelecionarData.edtDataInicio.Date;
   frmRelVendaPorData.QryVenda.ParamByName('DataFim').AsDate:=frmSelecionarData.edtDataFinal.Date;
   frmRelVendaPorData.QryVenda.Open;
   frmRelVendaPorData.Relatorio.PreviewModal;
Finally
      frmSelecionarData.Release;
End;
end;

procedure TfrmPrincipal.Vendas1Click(Sender: TObject);
begin
 frmProVenda := TfrmProVenda.create(self);
 frmProVenda.showModal;
 frmProVenda.release;
end;

procedure TfrmPrincipal.AlterarSenha1Click(Sender: TObject);
begin
  frmAlterarSenha := TfrmAlterarSenha.create(self);
 frmAlterarSenha.showModal;
 frmAlterarSenha.release;
end;

procedure   TfrmPrincipal.AtualizaBancoDados(aForm:TfrmAtualizaDB);
var oAtualizarMSSQL:TAtualizaBancoDadosMSSQL;
begin
  aForm.refresh;
  Sleep(300);

  try
    oAtualizarMSSQL:=TAtualizaBancoDadosMSSQL.Create(DtmPrincipal.ConexaoDB);
    oAtualizarMSSQL.AtualizarBancoDeDadosMSSQL;
  finally
    if Assigned(oAtualizarMSSQL) then
       FreeAndNil(oAtualizarMSSQL);
  end;
   
end;

end.
